//
// Created by Steffen Sch√ºmann on 04.10.24.
//

#include <doctest/doctest.h>

#include "chip8testhelper.hpp"

TEST_SUITE_BEGIN("CHIP-8-Test-Suite");

static std::string logoScreen = R"(................................................................
............#####.#....................#..........##............
..............#.....##.#...##..###...###.#..#..##..#............
..............#...#.#.#.#.#..#.#..#.#..#.#..#.#.................
..............#...#.#...#.####.#..#.#..#.#..#..#................
..............#...#.#...#.#....#..#.#..#.#..#...#...............
..............#...#.#...#..###.#..#..###..###.##................
................................................................
................................................................
...........#####...##.......##..#####...........#######.........
..........#######.###......###.#######.........###...###........
.........###...##.###......###.###..###.......###.....##........
........###.......###..........###...##.......###.....##........
........###..#.#..###.......##.###...##.......###.....##........
........###.......######...###.###...##........###...##.........
........###.#...#.#######..###.###...##.####....######..........
........###..###..###..###.###.###..###.####...###..###.........
........###.......###...##.###.#######........###....###........
........###.......###...##.###.######........###......##........
........###.......###...##.###.###...........###......##........
........###.......###...##.###.###.#.#...###.###......##........
.........###...##.###...##.###.###.###.....#.####....###........
..........#######.###...##.###.###...#...##...#########.........
...........#####..###...##.###.###...#.#.###...#######..........
................................................................
................................................................
.............###..##...##.#.......##......#.#....##.............
..............#..#..#.#...###....#...#..#...###.#..#............
..............#..####..#..#.......#..#..#.#.#...####............
..............#..#......#.#........#.#..#.#.#...#...............
..............#...###.##...##....##...###.#..##..###............
................................................................
)";

static void runTestForScreen(const std::string& test, const std::string& reference, std::string preset, uint8_t preselector = 0)
{
    auto [host, core, start] = createChip8Instance(preset);
    auto rom = loadFile(fs::path(CHIP8_TEST_SUITE) / "bin" / test);
    core->reset();
    host->load(rom);
    if(preselector) {
        host->writeByte(0x1ff, preselector);
    }
    int overFrames = 3;
    while (core->execMode() != emu::GenericCpu::ePAUSED) {
        host->executeFrame();
        if((core->opcode() & 0xF0FF) == 0xF00A && --overFrames == 0) {
            break;
        }
    }
    auto screen = host->chip8EmuScreen();
    CHECK(reference == screen);
}

TEST_CASE("chip-8: 1-chip8-logo.ch8")
{
    runTestForScreen("1-chip8-logo.ch8", logoScreen, "chip-8");
}

TEST_CASE("chip-8e: 1-chip8-logo.ch8")
{
    runTestForScreen("1-chip8-logo.ch8", logoScreen, "chip-8e");
}

TEST_CASE("chip-48: 1-chip8-logo.ch8")
{
    runTestForScreen("1-chip8-logo.ch8", logoScreen, "chip-48");
}

TEST_CASE("schip-1-0: 1-chip8-logo.ch8")
{
    runTestForScreen("1-chip8-logo.ch8", logoScreen, "schip-1-0");
}

TEST_CASE("schip-1-1: 1-chip8-logo.ch8")
{
    runTestForScreen("1-chip8-logo.ch8", logoScreen, "schip-1-1");
}

TEST_CASE("schipc: 1-chip8-logo.ch8")
{
    runTestForScreen("1-chip8-logo.ch8", logoScreen, "schipc");
}

TEST_CASE("schip-modern: 1-chip8-logo.ch8")
{
    runTestForScreen("1-chip8-logo.ch8", logoScreen, "schip-modern");
}

TEST_CASE("megachip: 1-chip8-logo.ch8")
{
    runTestForScreen("1-chip8-logo.ch8", logoScreen, "megachip");
}

TEST_CASE("xo-chip: 1-chip8-logo.ch8")
{
    runTestForScreen("1-chip8-logo.ch8", logoScreen, "xo-chip");
}

TEST_CASE("strict-chip-8: 1-chip8-logo.ch8")
{
    runTestForScreen("1-chip8-logo.ch8", logoScreen, "strict-chip-8");
}

TEST_CASE("vip-chip-8: 1-chip8-logo.ch8")
{
    runTestForScreen("1-chip8-logo.ch8", logoScreen, "vip-chip-8");
}

TEST_CASE("vip-chip-8e: 1-chip8-logo.ch8")
{
    runTestForScreen("1-chip8-logo.ch8", logoScreen, "vip-chip-8e");
}

static std::string ibmScreen = R"(................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
............########.#########...#####.........#####..#.#.......
......................................................#.#.......
............########.###########.######.......######...#........
................................................................
..............####.....###...###...#####.....#####....#.#.......
......................................................###.......
..............####.....#######.....#######.#######......#.......
........................................................#.......
..............####.....#######.....###.#######.###..............
.......................................................#........
..............####.....###...###...###..#####..###..............
......................................................###.......
............########.###########.#####...###...#####....#.......
......................................................##........
............########.#########...#####....#....#####..###.......
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
................................................................
)";


TEST_CASE("chip-8: 2-ibm-logo.ch8")
{
    runTestForScreen("2-ibm-logo.ch8", ibmScreen, "chip-8");
}

TEST_CASE("chip-8e: 2-ibm-logo.ch8")
{
    runTestForScreen("2-ibm-logo.ch8", ibmScreen, "chip-8e");
}

TEST_CASE("chip-48: 2-ibm-logo.ch8")
{
    runTestForScreen("2-ibm-logo.ch8", ibmScreen, "chip-48");
}

TEST_CASE("schip-1-0: 2-ibm-logo.ch8")
{
    runTestForScreen("2-ibm-logo.ch8", ibmScreen, "schip-1-0");
}

TEST_CASE("schip-1-1: 2-ibm-logo.ch8")
{
    runTestForScreen("2-ibm-logo.ch8", ibmScreen, "schip-1-1");
}

TEST_CASE("schipc: 2-ibm-logo.ch8")
{
    runTestForScreen("2-ibm-logo.ch8", ibmScreen, "schipc");
}

TEST_CASE("schip-modern: 2-ibm-logo.ch8")
{
    runTestForScreen("2-ibm-logo.ch8", ibmScreen, "schip-modern");
}

TEST_CASE("megachip: 2-ibm-logo.ch8")
{
    runTestForScreen("2-ibm-logo.ch8", ibmScreen, "megachip");
}

TEST_CASE("xo-chip: 2-ibm-logo.ch8")
{
    runTestForScreen("2-ibm-logo.ch8", ibmScreen, "xo-chip");
}

TEST_CASE("strict-chip-8: 2-ibm-logo.ch8")
{
    runTestForScreen("2-ibm-logo.ch8", ibmScreen, "strict-chip-8");
}

TEST_CASE("vip-chip-8: 2-ibm-logo.ch8")
{
    runTestForScreen("2-ibm-logo.ch8", ibmScreen, "vip-chip-8");
}

TEST_CASE("vip-chip-8e: 2-ibm-logo.ch8")
{
    runTestForScreen("2-ibm-logo.ch8", ibmScreen, "vip-chip-8e");
}

static std::string coraxScreen = R"(................................................................
..###.#.#.........###.#.#.........###.#.#.........###.###.......
...##..#...#.#......#..#...#.#....###.###..#.#....#...##...#.#..
....#.#.#..##.....##..#.#..##.....#.#...#..##.....##....#..##...
..###.#.#..#......###.#.#..#......###...#..#......#...##...#....
................................................................
..#.#.#.#.........###.###.........###.###.........###.###.......
..###..#...#.#....#.#.##...#.#....###.##...#.#....#....##..#.#..
....#.#.#..##.....#.#.#....##.....#.#...#..##.....##....#..##...
....#.#.#..#......###.###..#......###.##...#......#...###..#....
................................................................
..###.#.#.........###.###.........###.###.........###.###.......
..##...#...#.#....###.#.#..#.#....###...#..#.#....#...##...#.#..
....#.#.#..##.....#.#.#.#..##.....#.#..#...##.....##..#....##...
..##..#.#..#......###.###..#......###..#...#......#...###..#....
................................................................
..###.#.#.........###.##..........###..##.............#.#.......
....#..#...#.#....###..#...#.#....###.#....#.#....#.#..#...#.#..
...#..#.#..##.....#.#..#...##.....#.#.###..##.....#.#.#.#..##...
...#..#.#..#......###.###..#......###.###..#.......#..#.#..#....
................................................................
..###.#.#.........###.###.........###.###.......................
..###..#...#.#....###...#..#.#....###.##...#.#..................
....#.#.#..##.....#.#.##...##.....#.#.#....##...................
..##..#.#..#......###.###..#......###.###..#....................
................................................................
..##..#.#.........###.###.........###..##.............#.#...###.
...#...#...#.#....###..##..#.#....#...#....#.#....#.#.###.....#.
...#..#.#..##.....#.#...#..##.....##..###..##.....#.#...#...##..
..###.#.#..#......###.###..#......#...###..#.......#....#.#.###.
................................................................
................................................................
)";

TEST_CASE("chip-8: 3-corax+.ch8")
{
    runTestForScreen("3-corax+.ch8", coraxScreen, "chip-8");
}

TEST_CASE("chip-8e: 3-corax+.ch8")
{
    runTestForScreen("3-corax+.ch8", coraxScreen, "chip-8e");
}

TEST_CASE("chip-48: 3-corax+.ch8")
{
    runTestForScreen("3-corax+.ch8", coraxScreen, "chip-48");
}

TEST_CASE("schip-1-0: 3-corax+.ch8")
{
    runTestForScreen("3-corax+.ch8", coraxScreen, "schip-1-0");
}

TEST_CASE("schip-1-1: 3-corax+.ch8")
{
    runTestForScreen("3-corax+.ch8", coraxScreen, "schip-1-1");
}

TEST_CASE("schipc: 3-corax+.ch8")
{
    runTestForScreen("3-corax+.ch8", coraxScreen, "schipc");
}

TEST_CASE("schip-modern: 3-corax+.ch8")
{
    runTestForScreen("3-corax+.ch8", coraxScreen, "schip-modern");
}

TEST_CASE("megachip: 3-corax+.ch8")
{
    runTestForScreen("3-corax+.ch8", coraxScreen, "megachip");
}

TEST_CASE("xo-chip: 3-corax+.ch8")
{
    runTestForScreen("3-corax+.ch8", coraxScreen, "xo-chip");
}

TEST_CASE("strict-chip-8: 3-corax+.ch8")
{
    runTestForScreen("3-corax+.ch8", coraxScreen, "strict-chip-8");
}

TEST_CASE("vip-chip-8: 3-corax+.ch8")
{
    runTestForScreen("3-corax+.ch8", coraxScreen, "vip-chip-8");
}

TEST_CASE("vip-chip-8e: 3-corax+.ch8")
{
    runTestForScreen("3-corax+.ch8", coraxScreen, "vip-chip-8e");
}


static std::string flagsScreen = R"(#.#..#..##..##..#.#...##....................###.................
###.#.#.#.#.#.#.#.#....#...#.#.#.#.#.#........#..#.#.#.#.#.#....
#.#.###.##..##...#.....#...##..##..##.......##...##..##..##.....
#.#.#.#.#...#....#....###..#...#...#........###..#...#...#......
................................................................
###...................#.#...................###.................
.##..#.#.#.#.#.#......###..#.#.#.#.#.#.#.#..##...#.#.#.#.#.#.#.#
..#..##..##..##.........#..##..##..##..##.....#..##..##..##..##.
###..#...#...#..........#..#...#...#...#....##...#...#...#...#..
................................................................
###...................###...................###.................
#....#.#.#.#.#.#........#..#.#.#.#.#.#.#.#..##...#.#.#.#.#.#....
###..##..##..##.........#..##..##..##..##...#....##..##..##.....
###..#...#...#..........#..#...#...#...#....###..#...#...#......
................................................................
................................................................
###..#..##..##..#.#...#.#...................###.................
#...#.#.#.#.#.#.#.#...###..#.#.#.#.#.#.#.#..##...#.#.#.#.#.#.#.#
#...###.##..##...#......#..##..##..##..##.....#..##..##..##..##.
###.#.#.#.#.#.#..#......#..#...#...#...#....##...#...#...#...#..
................................................................
###...................###...................###.................
#....#.#.#.#.#.#........#..#.#.#.#.#.#.#.#..##...#.#.#.#.#.#....
###..##..##..##.........#..##..##..##..##...#....##..##..##.....
###..#...#...#..........#..#...#...#...#....###..#...#...#......
................................................................
................................................................
###.###.#.#.###.##....###.###.........................#.#...###.
#.#..#..###.##..#.#...#...##...#.#.#.#............#.#.###.....#.
#.#..#..#.#.#...##....##..#....##..##.............#.#...#...##..
###..#..#.#.###.#.#...#...###..#...#...............#....#.#.###.
................................................................
)";

TEST_CASE("chip-8: 4-flags.ch8")
{
    runTestForScreen("4-flags.ch8", flagsScreen, "chip-8");
}

TEST_CASE("chip-8e: 4-flags.ch8")
{
    runTestForScreen("4-flags.ch8", flagsScreen, "chip-8e");
}

TEST_CASE("chip-48: 4-flags.ch8")
{
    runTestForScreen("4-flags.ch8", flagsScreen, "chip-48");
}

TEST_CASE("schip-1-0: 4-flags.ch8")
{
    runTestForScreen("4-flags.ch8", flagsScreen, "schip-1-0");
}

TEST_CASE("schip-1-1: 4-flags.ch8")
{
    runTestForScreen("4-flags.ch8", flagsScreen, "schip-1-1");
}

TEST_CASE("schipc: 4-flags.ch8")
{
    runTestForScreen("4-flags.ch8", flagsScreen, "schipc");
}

TEST_CASE("schip-modern: 4-flags.ch8")
{
    runTestForScreen("4-flags.ch8", flagsScreen, "schip-modern");
}

TEST_CASE("megachip: 4-flags.ch8")
{
    runTestForScreen("4-flags.ch8", flagsScreen, "megachip");
}

TEST_CASE("xo-chip: 4-flags.ch8")
{
    runTestForScreen("4-flags.ch8", flagsScreen, "xo-chip");
}

TEST_CASE("strict-chip-8: 4-flags.ch8")
{
    runTestForScreen("4-flags.ch8", flagsScreen, "strict-chip-8");
}

TEST_CASE("vip-chip-8: 4-flags.ch8")
{
    runTestForScreen("4-flags.ch8", flagsScreen, "vip-chip-8");
}

TEST_CASE("vip-chip-8e: 4-flags.ch8")
{
    runTestForScreen("4-flags.ch8", flagsScreen, "vip-chip-8e");
}


static std::string quirksChip8Screen = R"(................................................................
.#.#.###.....##..###..##.###.###..........###.##................
.#.#.#.......#.#.##..##..##...#...........#.#.#.#..........#.#..
.#.#.##......##..#.....#.#....#...........#.#.#.#..........##...
..#..#.......#.#.###.##..###..#...........###.#.#..........#....
................................................................
.###.###.###.###.##..#.#..................###.##................
.###.##..###.#.#.#.#.#.#..................#.#.#.#..........#.#..
.#.#.#...#.#.#.#.##...#...................#.#.#.#..........##...
.#.#.###.#.#.###.#.#..#...................###.#.#..........#....
................................................................
.##..###..##.##......#.#..#..###.###......###.##................
.#.#..#..##..#.#.....#.#.#.#..#...#.......#.#.#.#..........#.#..
.#.#..#....#.##......###.###..#...#.......#.#.#.#..........##...
.##..###.##..#....#..###.#.#.###..#.......###.#.#..........#....
................................................................
.###.#...###.##..##..###.##...##..........###.##................
.#...#....#..#.#.#.#..#..#.#.#............#.#.#.#..........#.#..
.#...#....#..##..##...#..#.#.#.#..........#.#.#.#..........##...
.###.###.###.#...#...###.#.#..##..........###.#.#..........#....
................................................................
..##.#.#.###.###.###.###.##...##..........###.###.###...........
.##..###..#..#....#...#..#.#.#............#.#.#...#........#.#..
...#.#.#..#..##...#...#..#.#.#.#..........#.#.##..##.......##...
.##..#.#.###.#....#..###.#.#..##..........###.#...#........#....
................................................................
..##.#.#.###.##..###.##...##..............###.###.###...........
...#.#.#.###.#.#..#..#.#.#................#.#.#...#........#.#..
...#.#.#.#.#.##...#..#.#.#.#..............#.#.##..##.......##...
.##...##.#.#.#...###.#.#..##..............###.#...#........#....
................................................................
................................................................
)";

TEST_CASE("chip-8: 5-quirks.ch8")
{
    runTestForScreen("5-quirks.ch8", quirksChip8Screen, "chip-8", 1);
}

TEST_CASE("strict-chip-8: 5-quirks.ch8")
{
    runTestForScreen("5-quirks.ch8", quirksChip8Screen, "strict-chip-8", 1);
}

TEST_CASE("vip-chip-8: 5-quirks.ch8")
{
    runTestForScreen("5-quirks.ch8", quirksChip8Screen, "vip-chip-8", 1);
}

static std::string quirksSchipLegacyScreen = R"(................................................................
.#.#.###.....##..###..##.###.###..........###.###.###...........
.#.#.#.......#.#.##..##..##...#...........#.#.#...#........#.#..
.#.#.##......##..#.....#.#....#...........#.#.##..##.......##...
..#..#.......#.#.###.##..###..#...........###.#...#........#....
................................................................
.###.###.###.###.##..#.#..................###.###.###...........
.###.##..###.#.#.#.#.#.#..................#.#.#...#........#.#..
.#.#.#...#.#.#.#.##...#...................#.#.##..##.......##...
.#.#.###.#.#.###.#.#..#...................###.#...#........#....
................................................................
.##..###..##.##......#.#..#..###.###......#...##..###..##.......
.#.#..#..##..#.#.....#.#.#.#..#...#.......#...#.#.##..##...#.#..
.#.#..#....#.##......###.###..#...#.......#...##..#.....#..##...
.##..###.##..#....#..###.#.#.###..#.......###.#.#.###.##...#....
................................................................
.###.#...###.##..##..###.##...##..........##..###.###.#.#.......
.#...#....#..#.#.#.#..#..#.#.#............###.#.#..#..###..#.#..
.#...#....#..##..##...#..#.#.#.#..........#.#.#.#..#..#.#..##...
.###.###.###.#...#...###.#.#..##..........###.###..#..#.#..#....
................................................................
..##.#.#.###.###.###.###.##...##..........###.##................
.##..###..#..#....#...#..#.#.#............#.#.#.#..........#.#..
...#.#.#..#..##...#...#..#.#.#.#..........#.#.#.#..........##...
.##..#.#.###.#....#..###.#.#..##..........###.#.#..........#....
................................................................
..##.#.#.###.##..###.##...##..............###.##................
...#.#.#.###.#.#..#..#.#.#................#.#.#.#..........#.#..
...#.#.#.#.#.##...#..#.#.#.#..............#.#.#.#..........##...
.##...##.#.#.#...###.#.#..##..............###.#.#..........#....
................................................................
................................................................
)";

TEST_CASE("schip-1-1: 5-quirks.ch8")
{
    runTestForScreen("5-quirks.ch8", quirksSchipLegacyScreen, "schip-1-1", 4);
}

static std::string quirksSchipModernScreen = R"(................................................................
.#.#.###.....##..###..##.###.###..........###.###.###...........
.#.#.#.......#.#.##..##..##...#...........#.#.#...#........#.#..
.#.#.##......##..#.....#.#....#...........#.#.##..##.......##...
..#..#.......#.#.###.##..###..#...........###.#...#........#....
................................................................
.###.###.###.###.##..#.#..................###.###.###...........
.###.##..###.#.#.#.#.#.#..................#.#.#...#........#.#..
.#.#.#...#.#.#.#.##...#...................#.#.##..##.......##...
.#.#.###.#.#.###.#.#..#...................###.#...#........#....
................................................................
.##..###..##.##......#.#..#..###.###......##..###.##..###.......
.#.#..#..##..#.#.....#.#.#.#..#...#.......#.#.#.#.#.#.##...#.#..
.#.#..#....#.##......###.###..#...#.......#.#.#.#.#.#.#....##...
.##..###.##..#....#..###.#.#.###..#.......#.#.###.#.#.###..#....
................................................................
.###.#...###.##..##..###.##...##..........##..###.###.#.#.......
.#...#....#..#.#.#.#..#..#.#.#............###.#.#..#..###..#.#..
.#...#....#..##..##...#..#.#.#.#..........#.#.#.#..#..#.#..##...
.###.###.###.#...#...###.#.#..##..........###.###..#..#.#..#....
................................................................
..##.#.#.###.###.###.###.##...##..........###.##................
.##..###..#..#....#...#..#.#.#............#.#.#.#..........#.#..
...#.#.#..#..##...#...#..#.#.#.#..........#.#.#.#..........##...
.##..#.#.###.#....#..###.#.#..##..........###.#.#..........#....
................................................................
..##.#.#.###.##..###.##...##..............###.##................
...#.#.#.###.#.#..#..#.#.#................#.#.#.#..........#.#..
...#.#.#.#.#.##...#..#.#.#.#..............#.#.#.#..........##...
.##...##.#.#.#...###.#.#..##..............###.#.#..........#....
................................................................
................................................................
)";

TEST_CASE("schip-modern: 5-quirks.ch8")
{
    runTestForScreen("5-quirks.ch8", quirksSchipModernScreen, "schip-modern", 2);
}

static std::string quirksXoChipScreen = R"(................................................................
.#.#.###.....##..###..##.###.###..........###.###.###...........
.#.#.#.......#.#.##..##..##...#...........#.#.#...#........#.#..
.#.#.##......##..#.....#.#....#...........#.#.##..##.......##...
..#..#.......#.#.###.##..###..#...........###.#...#........#....
................................................................
.###.###.###.###.##..#.#..................###.##................
.###.##..###.#.#.#.#.#.#..................#.#.#.#..........#.#..
.#.#.#...#.#.#.#.##...#...................#.#.#.#..........##...
.#.#.###.#.#.###.#.#..#...................###.#.#..........#....
................................................................
.##..###..##.##......#.#..#..###.###......##..###.##..###.......
.#.#..#..##..#.#.....#.#.#.#..#...#.......#.#.#.#.#.#.##...#.#..
.#.#..#....#.##......###.###..#...#.......#.#.#.#.#.#.#....##...
.##..###.##..#....#..###.#.#.###..#.......#.#.###.#.#.###..#....
................................................................
.###.#...###.##..##..###.##...##..........##..###.##..###.......
.#...#....#..#.#.#.#..#..#.#.#............#.#.#.#.#.#.##...#.#..
.#...#....#..##..##...#..#.#.#.#..........#.#.#.#.#.#.#....##...
.###.###.###.#...#...###.#.#..##..........#.#.###.#.#.###..#....
................................................................
..##.#.#.###.###.###.###.##...##..........###.###.###...........
.##..###..#..#....#...#..#.#.#............#.#.#...#........#.#..
...#.#.#..#..##...#...#..#.#.#.#..........#.#.##..##.......##...
.##..#.#.###.#....#..###.#.#..##..........###.#...#........#....
................................................................
..##.#.#.###.##..###.##...##..............###.###.###...........
...#.#.#.###.#.#..#..#.#.#................#.#.#...#........#.#..
...#.#.#.#.#.##...#..#.#.#.#..............#.#.##..##.......##...
.##...##.#.#.#...###.#.#..##..............###.#...#........#....
................................................................
................................................................
)";

TEST_CASE("xo-chip: 5-quirks.ch8")
{
    runTestForScreen("5-quirks.ch8", quirksXoChipScreen, "xo-chip", 3);
}

TEST_SUITE_END();